version: "3"

services:
  db-1:
    image: mysql-exporter
    restart: always
    build:
      context: ./docker-workspace
      dockerfile: Dockerfile
    container_name: db1
    environment:
      - MYSQL_ROOT_PASSWORD=TEST
      - MYSQL_DATABASE=testdb
    ports:
      - "7001:3306"
      - "9100:9100"

  db-2:
    image: mysql
    container_name: db2
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=TEST
      - MYSQL_DATABASE=testdb
    ports:
      - "7002:3306"

  db-app-1:
    container_name: app1
    restart: always
    build:
      context: ./dev
      dockerfile: Dockerfile
    ports:
      - "7003:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://db1:3306/testdb
    depends_on:
      - db-1

  db-app-2:
    container_name: app2
    restart: always
    build:
      context: ./dev
      dockerfile: Dockerfile
    ports:
      - "7004:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://db2:3306/testdb
    depends_on:
      - db-2

  prometheus:
    image: prom/prometheus
    container_name: prom-service
    ports:
      - "9090:9090"